<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<div id="test">
</div>

<!--<script src="src/assembler/assembler.js"></script>-->

<!--&lt;!&ndash; Body componentu &ndash;&gt;-->
<!--<div>-->

    <!--<spike for="item in items">-->
        <!--<element name="personalData" params="item"></element>-->
    <!--</spike>-->

    <!--<element name="footer"></element>-->

<!--</div>-->

<!--<element name="app.element.TopMenu"></element>-->

<!--<div spike-view></div>-->


<!--<div spike-modals></div>-->

<script>

    var spike = { core: {} };

    spike.core.Request_config_array = function (config, array) {
        this.config = config;
        this.array = array;
    };
    spike.core.Request_config = function (config) {

        this.config = this.setConfig(config);
        this.xhr = this.createXHR();

        this.setEvents();
        this.setHeaders();

        this.config.beforeSend();
        this.xhr.send(this.config.data);

    };
    spike.core.Request = function () {
    };
    spike.core.Request.prototype.config = null;
    spike.core.Request.prototype.xhr = null;
    spike.core.Request.prototype.catchCallbacks = [];
    spike.core.Request.prototype.thenCallbacks = [];
    spike.core.Request.prototype.response = null;
    spike.core.Request.prototype.responseType = 'json';
    spike.core.Request.prototype.STATUS = {
        DONE: 4,
        LOADING: 3,
        HEADERS_RECEIVED: 2,
        OPENED: 1,
        UNSENT: 0
    };
    spike.core.Request.prototype.setConfig = function (config) {
        var $this = this;

        if (config === undefined || config === null) {
            spike.core.Errors.throwError(spike.core.Errors.messages.REQUEST_WRONG_PARAMS, []);
        }

        if (config.url === undefined || config.type === undefined) {
            spike.core.Errors.throwError(spike.core.Errors.messages.REQUEST_WRONG_PARAMS, []);
        }

        if (config.headers === undefined) {
            config.headers = {};
        }

        if (config.contentType === undefined) {
            config.headers['Content-Type'] = 'application/json';
        }

        if (config.data === undefined) {
            config.data = {};
        }

        if (typeof config.data === 'string') {

            try {
                config.data = JSON.parse(config.data);
            } catch (e) {
                spike.core.Errors.thrownError(spike.core.Errors.JSON_PARSE_ERROR, [config.url]);
            }

        }

        if (config.beforeSend === undefined) {
            config.beforeSend = function () {
            };
        }

        if (config.complete === undefined) {
            config.complete = function () {
            };
        }

        return config;

    };
    spike.core.Request.prototype.setEvents = function () {
        var $this = this;

        this.xhr.open(this.config.type, this.config.url, true);

        var self = this;
        this.xhr.onreadystatechange = function () {

            if (self.xhr.readyState === self.STATUS.DONE && self.xhr.status === 200) {

                if (self.responseType === 'json') {

                    try {
                        self.response = JSON.parse(self.xhr.responseText);
                        self.resolveThen(self.response, self.xhr, self.xhr.status);
                    } catch (e) {
                        self.resolveCatch(self.xhr, 0, e);
                    }


                } else if (self.responseType === 'xml') {
                    self.resolveThen(self.xhr.responseXML, self.xhr, self.xhr.status);
                }

            } else if (self.xhr.readyState === self.STATUS.DONE && self.xhr.status === 204) {
                self.resolveThen(null, self.xhr, self.xhr.status);
            } else if (self.xhr.readyState === self.STATUS.DONE && self.xhr.status !== 200) {
                self.resolveCatch(self.xhr, self.xhr.status, new Error('Response error: ' + self.xhr.status));
            }

        };


    };
    spike.core.Request.prototype.setHeaders = function () {
        var $this = this;

        this.xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        for (var headerName in this.config.headers) {
            this.xhr.setRequestHeader(headerName, this.config.headers[headerName]);
        }

        if (this.config.headers['Content-Type'].indexOf('xml') > -1) {
            this.responseType = 'xml';
        }

    };
    spike.core.Request.prototype.then = function (callback) {
        var $this = this;
        this.thenCallbacks.push(callback);
        return this;
    };
    spike.core.Request.prototype.resolveThen = function (response, xhr, status) {
        var $this = this;

        for (var i = 0; i < this.thenCallbacks.length; i++) {
            this.thenCallbacks[i](response, xhr, status);
        }

    };
    spike.core.Request.prototype.catch = function (callback) {
        var $this = this;
        this.catchCallbacks.push(callback);
        return this;
    };
    spike.core.Request.prototype.resolveCatch = function (xhr, status, thrownError) {
        var $this = this;

        for (var i = 0; i < this.catchCallbacks.length; i++) {
            this.catchCallbacks[i](xhr, status, thrownError);
        }

    };
    spike.core.Request.prototype.createXHR = function () {
        var $this = this;

        var xhr;
        if (window.XMLHttpRequest) {
            xhr = new XMLHttpRequest();
        } else if (window.ActiveXObject) {
            try {
                xhr = new ActiveXObject("Msxml2.XMLHTTP");
            } catch (e) {
                xhr = new ActiveXObject("Microsoft.XMLHTTP");
            }
        }

        return xhr;

    };
    spike.core.Request.prototype.getSuper = function () {
        var $this = this;
        return 'null';
    };
    spike.core.Request.prototype.getClass = function () {
        var $this = this;
        return 'spike.core.Request';
    };
    spike.core.Request_config_array.prototype = spike.core.Request.prototype;
    spike.core.Request_config.prototype = spike.core.Request.prototype;


</script>
</body>
</html>